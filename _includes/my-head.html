<!-- Force sidebar to always start closed (Cover Page) on reload -->
<script>
  (function() {
    // Debug helper
    var debug = true;
    function log(msg) { if(debug) console.log('[CoverFix] ' + msg); }

    log('Initializing Cover Page fix...');

    // 1. Force manual scroll restoration immediately
    if ('scrollRestoration' in history) {
      history.scrollRestoration = 'manual';
    }

    // 2. Clear the "closedOnce" flag from history state
    function clearClosedOnce() {
      if (history.state && history.state.closedOnce) {
        log('Found closedOnce in state. Removing...');
        try {
          var newState = Object.assign({}, history.state);
          delete newState.closedOnce;
          history.replaceState(newState, document.title);
          log('closedOnce removed.');
        } catch (e) {
          log('Error clearing state: ' + e);
        }
      }
    }
    clearClosedOnce();

    // 3. Intercept history.replaceState and pushState
    // This blocks Hydejack from saving the "closedOnce" flag in the first place
    var originalReplaceState = history.replaceState;
    history.replaceState = function(state, title, url) {
      if (state && typeof state === 'object' && state.closedOnce) {
        log('Intercepted replaceState setting closedOnce. Stripping it.');
        var s = Object.assign({}, state);
        delete s.closedOnce;
        return originalReplaceState.call(history, s, title, url);
      }
      return originalReplaceState.apply(history, arguments);
    };

    var originalPushState = history.pushState;
    history.pushState = function(state, title, url) {
      if (state && typeof state === 'object' && state.closedOnce) {
        log('Intercepted pushState setting closedOnce. Stripping it.');
        var s = Object.assign({}, state);
        delete s.closedOnce;
        return originalPushState.call(history, s, title, url);
      }
      return originalPushState.apply(history, arguments);
    };

    // 4. Aggressively force scroll to top
    // Run for approx 2 seconds (120 frames) to be absolutely sure
    var count = 0;
    var forceScroll = function() {
      if (window.scrollY !== 0) {
        window.scrollTo(0, 0);
      }
      if (count++ < 120) {
        requestAnimationFrame(forceScroll);
      }
    };
    requestAnimationFrame(forceScroll);

    // 5. Cleanup on unload to ensure next load starts clean
    window.addEventListener('beforeunload', function() {
      clearClosedOnce();
      window.scrollTo(0, 0);
    });

    log('Fix setup complete.');
  })();
</script>

